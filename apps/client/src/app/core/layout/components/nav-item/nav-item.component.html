<div class="px-3 cursor-pointer">
  <!-- PARENT (desktop link; hidden on mobile if has subitems) -->
  @if (hasTooltipFor(item().to)) {
    <div
      flexTooltipTrigger
      [flexTooltipTrigger]="parentTooltip"
      [openDelay]="openDelay()"
      [routerLink]="item().to"
      [state]="item().from ? { from: item().from } : undefined"
      [class]="
        navLinkClassNames({
          to: item().to,
          isActive: isActive(item().to),
          isSetting: isSetting()
        }) +
        ' ' +
        parentLinkExtraClasses()
      "
    >
      @if (!isSetting()) {
        <div class="flex size-6 items-center justify-center">
          @if (item().icon) {
            <i-lucide [img]="item().icon" class="h-4 w-4"></i-lucide>
          }
        </div>
      }
      <span class="font-medium font-sans txt-compact-small">{{
        item().label | transloco
      }}</span>
    </div>

    <ng-template #parentTooltip>
      @if (shortcutFor(item().to); as sc) {
        <div
          flexTooltip
          class="txt-compact-xsmall flex h-5 items-center justify-between gap-x-2 whitespace-nowrap"
        >
          <span>{{ sc.label | transloco }}</span>

          <div class="flex items-center gap-x-1">
            @for (key of (sc.keys.Mac ?? []); track key; let i = $index) {
              <div class="flex items-center gap-x-1">
                <kbd
                  class="bg-ui-bg-field-component rounded px-1.5 py-0.5 text-[11px] font-medium leading-none"
                >
                  {{ key }}
                </kbd>

                @if (i < (sc.keys.Mac?.length ?? 0) - 1) {
                  <span class="text-ui-fg-muted txt-compact-xsmall">
                    {{ thenLabel() | transloco }}
                  </span>
                }
              </div>
            }
          </div>

          <div flexTooltipArrow></div>
        </div>
      }
    </ng-template>
  } @else {
    <div
      [routerLink]="item().to"
      [state]="item().from ? { from: item().from } : undefined"
      [class]="
        navLinkClassNames({
          to: item().to,
          isActive: isActive(item().to),
          isSetting: isSetting()
        }) +
        ' ' +
        parentLinkExtraClasses()
      "
    >
      @if (!isSetting()) {
        <div class="flex size-6 items-center justify-center">
          @if (item().icon) {
            <i-lucide [img]="item().icon" class="h-4 w-4"></i-lucide>
          }
        </div>
      }
      <span class="font-medium font-sans txt-compact-small">{{ item().label | transloco }}</span>
    </div>
  }

  <!-- MOBILE: collapsible (shows parent + sub items) -->
  @if (resolvedItems().length > 0) {
    <div flexCollapsibleRoot [open]="open()" (openChange)="open.set($event)">
      <button
        flexCollapsibleTrigger
        type="button"
        [class]="
          clx(
            'text-ui-fg-subtle hover:text-ui-fg-base transition-fg hover:bg-ui-bg-subtle-hover flex w-full items-center gap-x-2 rounded-md py-0.5 pl-0.5 pr-2 outline-none lg:hidden',
            { 'pl-2': isSetting() }
          )
        "
      >
        <div class="flex size-6 items-center justify-center">
          @if (item().icon) {
            <i-lucide [img]="item().icon" class="h-4 w-4"></i-lucide>
          }
        </div>
        <span class="font-medium font-sans txt-compact-small">{{ item().label | transloco }}</span>
      </button>

      <div flexCollapsibleContent>
        <div *flexCollapsibleContentPresence>
          <div class="flex flex-col pt-1">
            <div class="flex flex-col gap-1">
              <!-- parent entry inside collapsible -->
              <div class="flex w-full items-center gap-2 lg:hidden">
                @if (hasTooltipFor(item().to)) {
                  <div
                    flexTooltipTrigger
                    [flexTooltipTrigger]="parentNestedTooltip"
                    [openDelay]="openDelay()"
                    [routerLink]="item().to"
                    [class]="
                      navLinkClassNames({
                        to: item().to,
                        isActive: isActive(item().to),
                        isSetting: isSetting(),
                        isNested: true
                      })
                    "
                  >
                    <span class="font-medium font-sans txt-compact-small">{{
                      item().label
                    }}</span>
                  </div>

                  <ng-template #parentNestedTooltip>
                    @if (shortcutFor(item().to); as sc) {
                      <div
                        flexTooltip
                        class="txt-compact-xsmall flex h-5 items-center justify-between gap-x-2 whitespace-nowrap"
                      >
                        <span>{{ sc.label | transloco }}</span>
                        <div class="flex items-center gap-1">
                          @for (key of (sc.keys.Mac ?? []); track key; let i = $index) {
                            <div class="flex items-center gap-x-1">
                              <kbd
                                class="bg-ui-bg-field-component rounded px-1.5 py-0.5 text-[11px] font-medium leading-none"
                              >
                                {{ key }}
                              </kbd>
                              @if (i < (sc.keys.Mac?.length ?? 0) - 1) {
                                <span class="text-ui-fg-muted txt-compact-xsmall">{{
                                  thenLabel() | transloco
                                }}</span>
                              }
                            </div>
                          }
                        </div>
                        <div flexTooltipArrow></div>
                      </div>
                    }
                  </ng-template>
                } @else {
                  <div
                    [routerLink]="item().to"
                    [class]="
                      navLinkClassNames({
                        to: item().to,
                        isActive: isActive(item().to),
                        isSetting: isSetting(),
                        isNested: true
                      })
                    "
                  >
                      <span class="font-medium font-sans txt-compact-small">{{
                        item().label | transloco
                      }}</span>
                  </div>
                }
              </div>

              <!-- sub links -->
              @for (sub of resolvedItems(); track sub.to) {
                <div class="flex items-center">
                  @if (hasTooltipFor(sub.to)) {
                    <div
                      flexTooltipTrigger
                      [flexTooltipTrigger]="subTooltip"
                      [openDelay]="openDelay()"
                      [routerLink]="sub.to"
                      [class]="
                        navLinkClassNames({
                          to: sub.to,
                          isActive: isActive(sub.to),
                          isSetting: isSetting(),
                          isNested: true
                        })
                      "
                    >
                      <span class="font-medium font-sans txt-compact-small">{{
                        sub.label | transloco
                      }}</span>
                    </div>

                    <ng-template #subTooltip>
                      @if (shortcutFor(sub.to); as sc) {
                        <div
                          flexTooltip
                          class="txt-compact-xsmall flex h-5 items-center justify-between gap-x-2 whitespace-nowrap"
                        >
                          <span>{{ sc.label | transloco }}</span>
                          <div class="flex items-center gap-x-1">
                            @for (key of (sc.keys.Mac ?? []); track key; let i = $index) {
                              <div class="flex items-center gap-x-1">
                                <kbd
                                  class="bg-ui-bg-field-component rounded px-1.5 py-0.5 text-[11px] font-medium leading-none"
                                >
                                  {{ key }}
                                </kbd>
                                @if (i < (sc.keys.Mac?.length ?? 0) - 1) {
                                  <span class="text-ui-fg-muted txt-compact-xsmall">{{
                                  thenLabel() | transloco
                                  }}</span>
                                }
                              </div>
                            }
                          </div>
                          <div flexTooltipArrow></div>
                        </div>
                      }
                    </ng-template>
                  } @else {
                    <div
                      [routerLink]="sub.to"
                      [class]="
                        navLinkClassNames({
                          to: sub.to,
                          isActive: isActive(sub.to),
                          isSetting: isSetting(),
                          isNested: true
                        })
                      "
                    >
                    <span class="font-medium font-sans txt-compact-small">{{
                      sub.label | transloco
                    }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>
