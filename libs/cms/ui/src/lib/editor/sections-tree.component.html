<div
  class="w-[280px] bg-ui-bg-base border-r border-ui-border-base flex flex-col h-full"
>
  <div class="px-4 py-3 border-b border-ui-border-base">
    <h2 class="text-sm font-semibold text-ui-fg-base">{{ 'cms.editor.sections.title' | transloco }}</h2>
    <p class="text-xs text-ui-fg-muted mt-0.5">{{ 'cms.editor.sections.dragToReorder' | transloco }}</p>
  </div>

  <cms-scroll-area className="flex-1">
    <div class="py-2" (dragend)="onDragEnd()">
      @if (sections.length === 0) {
      <div class="px-4 py-8 text-center">
        <p class="text-sm text-ui-fg-muted">{{ 'cms.editor.sections.emptyTitle' | transloco }}</p>
        <p class="text-xs text-ui-fg-muted mt-1">
          {{ 'cms.editor.sections.emptyDescription' | transloco }}
        </p>
      </div>
      } @else { @for (section of sections; track section.id; let index = $index)
      {
      <div (dragenter)="onDragEnter(index)">
        <div
          class="relative"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, index)"
        >
          @if (dragOverIndex === index) {
          <div
            class="absolute inset-x-0 top-0 h-0.5 bg-ui-bg-interactive z-10"
          ></div>
          }
          <div
            class="group flex items-center gap-2 px-3 py-2.5 cursor-pointer transition-colors border-l-2"
            [class.bg-ui-bg-subtle]="isSectionSelected(section)"
            [class.border-l-ui-border-interactive]="isSectionSelected(section)"
            [class.border-l-transparent]="!isSectionSelected(section)"
            [class.hover:bg-ui-bg-subtle-hover]="!isSectionSelected(section)"
            [class.opacity-50]="!section.visible"
            (click)="selectNode.emit(section.id)"
            (keydown.enter)="selectNode.emit(section.id)"
            (keydown.space)="
              $event.preventDefault(); selectNode.emit(section.id)
            "
            role="button"
            tabindex="0"
            draggable="true"
            (dragstart)="onDragStart($event, index)"
          >
            <div class="flex gp-1 items-center">
              <i-lucide
                class="p-0.5 -ml-1 cursor-grab active:cursor-grabbing opacity-0 group-hover:opacity-100 transition-opacity text-ui-fg-muted hover:text-ui-fg-base"
                [img]="GripVertical"
                (mousedown)="$event.stopPropagation()"
              ></i-lucide>

              @if (section.blocks.length > 0) {
              <i-lucide
                (click)="$event.stopPropagation(); toggleExpanded(section.id)"
                class="p-0.5 text-ui-fg-muted hover:text-ui-fg-base transition-colors -ml-0.5"
                [class.rotate-90]="expandedSections.has(section.id)"
                [img]="ChevronRight"
                (mousedown)="$event.stopPropagation()"
              ></i-lucide>
              } @else {
              <div class="w-6"></div>
              }
            </div>

            <i-lucide
              [img]="iconClass(section.icon)"
              class="w-4 h-4 text-muted-foreground shrink-0 text-ui-fg-muted hover:text-ui-fg-base'"
            ></i-lucide>

            <span class="text-sm font-medium truncate flex-1">{{
              section.name
            }}</span>

            <div
              class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity"
            >
              <button
                type="button"
                (click)="
                  $event.stopPropagation(); toggleVisibility.emit(section.id)
                "
                class="p-1.5 rounded hover:bg-ui-bg-subtle-hover text-ui-fg-muted hover:text-ui-fg-base transition-colors"
              >
                <i
                  class="pi"
                  [class.pi-eye]="section.visible"
                  [class.pi-eye-slash]="!section.visible"
                ></i>
              </button>
              <button
                type="button"
                (click)="
                  $event.stopPropagation(); duplicateNode.emit(section.id)
                "
                class="p-1.5 rounded hover:bg-ui-bg-subtle-hover text-ui-fg-muted hover:text-ui-fg-base transition-colors"
              >
                <i class="pi pi-copy text-xs"></i>
              </button>
              <button
                type="button"
                (click)="$event.stopPropagation(); confirmDelete(section)"
                class="p-1.5 rounded hover:bg-ui-button-danger/10 text-ui-fg-muted hover:text-ui-fg-error transition-colors"
              >
                <i class="pi pi-trash text-xs"></i>
              </button>
            </div>
          </div>

          @if (section.blocks.length > 0 && expandedSections.has(section.id)) {
          <div class="ml-9 border-l border-ui-border-base">
            @for (block of section.blocks; track block.id) {
            <div
              class="flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors border-l-2"
              [class.bg-ui-bg-subtle]="isBlockSelected(section.id, block.id)"
              [class.border-l-ui-border-interactive]="
                isBlockSelected(section.id, block.id)
              "
              [class.border-l-transparent]="
                !isBlockSelected(section.id, block.id)
              "
              [class.hover:bg-ui-bg-subtle-hover]="
                !isBlockSelected(section.id, block.id)
              "
              (click)="selectNode.emit(block.id)"
              (keydown.enter)="selectNode.emit(block.id)"
              (keydown.space)="
                $event.preventDefault(); selectNode.emit(block.id)
              "
              role="button"
              tabindex="0"
            >
              <div class="w-1.5 h-1.5 rounded-full bg-ui-fg-muted"></div>
              <span class="text-sm text-ui-fg-muted">{{ block.name }}</span>
            </div>
            }
          </div>
          }
        </div>
      </div>
      } }
    </div>
  </cms-scroll-area>

  <div class="p-4 border-t border-ui-border-base">
    <cms-button
      variant="outline"
      className="w-full gap-2"
      (click)="openSectionLibrary.emit()"
    >
      <i class="pi pi-plus text-xs"></i>
      {{ 'cms.editor.sections.addSection' | transloco }}
    </cms-button>
  </div>
</div>

<cms-dialog
  [open]="!!pendingDelete"
  (openChange)="cancelDelete()"
  contentClass="w-full max-w-md rounded-lg border border-ui-border-base bg-ui-bg-base shadow-lg"
>
  <div class="p-6 space-y-4">
    <div>
      <h3 class="text-lg font-semibold text-ui-fg-base">{{ 'cms.editor.sections.deleteTitle' | transloco }}</h3>
      <p class="text-sm text-ui-fg-muted mt-2">
        {{ 'cms.editor.sections.deleteDescription' | transloco: { name: pendingDelete?.name } }}
      </p>
    </div>
    <div class="flex justify-end gap-2">
      <cms-button variant="outline" (click)="cancelDelete()">{{ 'common.cancel' | transloco }}</cms-button>
      <cms-button variant="destructive" (click)="deleteSection()"
        >{{ 'common.delete' | transloco }}</cms-button
      >
    </div>
  </div>
</cms-dialog>
